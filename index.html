<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackify</title>
    <!-- Chosen Palette: Modern Horizon (soft blues, warm grays, deep greens) -->
    <!-- Application Structure Plan: The single-page app is now designed with a clear visual hierarchy. A top-level container with a gradient background sets a welcoming tone. The main content is split into a two-column grid on large screens, with the map taking priority on the left and a consolidated control panel on the right. On smaller screens, the layout gracefully collapses into a single column. The control panel is structured with distinct, card-like sections for "Tracking," "Route Details," and "Stops," each with its own state-driven content. Interactive elements like buttons and the summary text now have loading spinners and smooth transitions to provide clear feedback. This structure prioritizes immediate user action (tracking a bus) and then dynamically reveals the relevant information in a logical, step-by-step fashion. The simulation now features automatic movement, which is controlled by a new button, while existing buttons for delay and reset provide override functionality. -->
    <!-- Visualization & Content Choices: Report Info: Bus location, route, stops, and ETAs. -> Goal: Provide a clear, real-time spatial and textual representation of the bus journey. -> Viz/Presentation Method: An interactive map (Leaflet.js) for spatial data and a dynamically updated, visually-enhanced HTML list for textual stop-by-stop data. LLM-generated text for summaries and delay reasons provides a richer, more engaging narrative. -> Interaction: User enters a bus number to initiate tracking. The app's state changes, revealing the info panel. The map and stop list update based on driver simulation controls. The new summary button provides on-demand, LLM-powered context for the route. The ETA and ATA are now dynamically calculated based on the simulation flow, providing a more realistic representation. A reset button allows the user to re-run the simulation. New functionality includes automatic, smooth bus movement with user-controlled start/stop actions. -> Justification: The combination of mapping, dynamic lists, and LLM content offers both a functional tool and an engaging, informative experience. The UI is designed to minimize clutter and focus the user's attention on one task at a time. -> Library/Method: Leaflet.js for mapping, Vanilla JS for all core state management and DOM manipulation, and the Gemini API for generative text. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            background-color: #f0f4f8;
            background-image: linear-gradient(170deg, #e6f0ff 0%, #f0f4f8 100%);
            font-family: 'Poppins', sans-serif;
            padding-top: 80px; /* Offset for fixed navbar */
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 1rem;
        }
        .leaflet-container {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .stop-list-container, #chat-messages {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #a5b4fc #e0e7ff;
        }
        .stop-list-container::-webkit-scrollbar, #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .stop-list-container::-webkit-scrollbar-track, #chat-messages::-webkit-scrollbar-track {
            background: #e0e7ff;
        }
        .stop-list-container::-webkit-scrollbar-thumb, #chat-messages::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 3px;
        }
        .stop-list-container::-webkit-scrollbar-thumb:hover, #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }
        .stop-list-container {
             max-height: 250px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-element {
            animation: fadeIn 0.6s ease-out forwards;
        }
        .btn-base {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            box-shadow: 0 7px 14px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }
        .input-base {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        .input-base:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .nav-link.active {
             color: #3b82f6;
             font-weight: 700;
        }
        /* Chatbot Styles */
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-message-bot {
            background-color: #e2e8f0;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .typing-indicator::after {
            content: '.';
            animation: typing 1.5s infinite;
        }
        #payment-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #payment-modal > div {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased min-h-screen">
    <nav class="bg-white/80 backdrop-blur-sm shadow-sm fixed top-0 left-0 right-0 z-50 transition-transform duration-300 ease-in-out">
        <div class="container mx-auto max-w-7xl px-6">
            <div class="flex justify-between items-center h-20">
                <div class="flex-shrink-0">
                    <a href="#live-tracking" class="nav-link text-2xl font-extrabold text-slate-900 tracking-tight">Trackify</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-2">
                        <a href="#live-tracking" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium active">Live Tracking</a>
                        <a href="#ticket-booking" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Ticket Booking</a>
                        <a href="#emergency-contacts" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Emergency</a>
                        <a href="#chatbot" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Assistant</a>
                        <a href="#about" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">About Us</a>
                        <a href="#contact" class="nav-link text-slate-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Contact</a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="nav-toggle" class="bg-slate-100 inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-slate-800 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#live-tracking" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium active">Live Tracking</a>
                <a href="#ticket-booking" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium">Ticket Booking</a>
                <a href="#emergency-contacts" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium">Emergency Contacts</a>
                <a href="#chatbot" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium">Chatbot</a>
                <a href="#about" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium">About Us</a>
                <a href="#contact" class="nav-link text-slate-600 hover:bg-blue-50 hover:text-blue-600 block px-3 py-2 rounded-md text-base font-medium">Contact</a>
            </div>
        </div>
    </nav>

    <div id="main-container" class="container mx-auto max-w-7xl pb-8 px-6">
        <section id="live-tracking" class="page pt-10">
            <header class="text-center mb-10 md:mb-16">
                <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 drop-shadow-lg">Live Bus Tracking</h1>
                <p class="text-slate-500 mt-2 text-lg">Your journey, on time. Know where your bus is, every step of the way.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="lg:col-span-1 flex flex-col gap-8">
                    <div class="h-[60vh] lg:h-full card p-3">
                        <div id="map"></div>
                    </div>
                </div>

                <div class="lg:col-span-1 flex flex-col gap-8">
                    <div class="card p-6 fade-in-element">
                        <h2 class="font-bold text-2xl mb-4 text-slate-900">Track a Bus</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="bus-number-input" placeholder="e.g., 707, 808, 909" class="w-full input-base">
                            <button id="track-btn" class="w-full sm:w-auto btn-base btn-primary">Track</button>
                        </div>
                    </div>

                    <div id="info-panel" class="card p-6 flex-grow flex flex-col hidden transition-all duration-300 ease-in-out fade-in-element">
                        <div id="notification-panel" class="mb-4 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out"></div>
                        
                        <h3 class="font-semibold text-xl mb-2 text-slate-900">Route Details</h3>
                        <div class="flex justify-between text-sm mb-4 bg-slate-50 p-4 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-500">Start Point</p>
                                <p id="start-point" class="text-slate-800 font-semibold">-</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium text-slate-500">End Point</p>
                                <p id="end-point" class="text-slate-800 font-semibold">-</p>
                            </div>
                        </div>
                         <div class="text-sm mb-4">
                            <button id="summary-btn" class="w-full btn-base btn-secondary">Get Route Summary</button>
                            <div id="summary-text" class="mt-4 p-4 bg-slate-50 rounded-lg text-slate-600 hidden transition-all duration-300 ease-in-out"></div>
                            <div id="summary-spinner" class="animate-spin h-6 w-6 border-4 border-slate-300 border-t-transparent rounded-full mx-auto my-4 hidden"></div>
                        </div>

                        <div class="flex-grow flex flex-col min-h-0">
                            <h3 class="font-semibold text-xl mb-2 text-slate-900">Stops</h3>
                            <div class="stop-list-container bg-slate-50 rounded-lg p-2">
                                <div id="stop-list-content"></div>
                            </div>
                        </div>
                    </div>
                     <div id="welcome-panel" class="card p-6 flex-grow flex flex-col items-center justify-center transition-all duration-300 ease-in-out fade-in-element">
                        <div class="w-2/3 max-w-xs mx-auto mb-6">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#94a3b8" class="w-full h-full">
                                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                <g id="SVGRepo_iconCarrier">
                                    <path d="M17 17.5999H18.4C19.9941 17.5999 21.3 16.321 21.3 14.7599V9.2399C21.3 7.6789 19.9941 6.3999 18.4 6.3999H5.6C4.00588 6.3999 2.7 7.6789 2.7 9.2399V14.7599C2.7 16.321 4.00588 17.5999 5.6 17.5999H7M17 17.5999V20.3999C17 20.8836 16.5971 21.2999 16.1 21.2999H14.9C14.4029 21.2999 14 20.8836 14 20.3999V17.5999M17 17.5999H7M7 17.5999V20.3999C7 20.8836 7.40294 21.2999 7.9 21.2999H9.1C9.59706 21.2999 10 20.8836 10 20.3999V17.5999M12 2.6999V6.3999M9 3.5999L9.21557 3.82338C10.9329 5.59217 13.0671 5.59217 14.7844 3.82338L15 3.5999" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></g>
                                </g>
                            </svg>
                        </div>
                        <p class="text-slate-500 text-center text-lg">Enter a bus number to begin tracking.</p>
                    </div>
                </div>
            </main>
        </section>

        <section id="ticket-booking" class="page hidden py-16">
            <header class="text-center mb-10 md:mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 drop-shadow-lg">Book Your Ticket</h1>
                <p class="text-slate-500 mt-2 text-lg">Plan your trip and book your seat in just a few clicks.</p>
            </header>
            <div class="max-w-3xl mx-auto card p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="from-stop" class="block text-sm font-medium text-slate-700 mb-2">From</label>
                        <select id="from-stop" class="w-full input-base"></select>
                    </div>
                    <div>
                        <label for="to-stop" class="block text-sm font-medium text-slate-700 mb-2">To</label>
                        <select id="to-stop" class="w-full input-base"></select>
                    </div>
                </div>
                <button id="find-buses-btn" class="w-full btn-base btn-primary">Find Available Buses</button>
            </div>

            <div id="bus-results-container" class="max-w-3xl mx-auto mt-8 hidden">
                <h3 class="text-2xl font-bold text-slate-800 mb-4">Available Buses</h3>
                <div id="bus-results-list" class="space-y-4">
                    <!-- Dynamic bus results will be injected here -->
                </div>
            </div>
        </section>
        
        <section id="emergency-contacts" class="page hidden py-20">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center text-slate-900 mb-8">Emergency Helplines</h2>
                <div class="max-w-4xl mx-auto card p-6 fade-in-element">
                     <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                         <a href="tel:1091" class="flex items-center justify-center gap-3 btn-base bg-pink-500 text-white hover:bg-pink-600 text-base px-6 py-4">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3M15 21a2 2 0 002-2v-1a2 2 0 00-2-2h-3a2 2 0 00-2 2v1a2 2 0 002 2h3z"></path></svg>
                             <span>Women Helpline</span>
                         </a>
                         <a href="tel:100" class="flex items-center justify-center gap-3 btn-base bg-blue-500 text-white hover:bg-blue-600 text-base px-6 py-4">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                             <span>Police</span>
                         </a>
                         <a href="tel:108" class="flex items-center justify-center gap-3 btn-base bg-red-500 text-white hover:bg-red-600 text-base px-6 py-4">
                              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                             <span>Ambulance</span>
                         </a>
                          <a href="tel:101" class="flex items-center justify-center gap-3 btn-base bg-orange-500 text-white hover:bg-orange-600 text-base px-6 py-4">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88a3 3 0 00-4.242 4.242z"></path></svg>
                             <span>Fire Brigade</span>
                         </a>
                     </div>
                </div>
            </div>
        </section>

         <section id="chatbot" class="page hidden py-16">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center text-slate-900 mb-8">Trackify Assistant</h2>
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg flex flex-col h-[70vh]">
                    <div class="p-4 border-b border-slate-200">
                        <p class="text-lg font-semibold text-center text-slate-800">How can I help you today?</p>
                    </div>
                    <div id="chat-messages" class="flex-grow p-6 flex flex-col space-y-4">
                        <!-- Messages will be appended here -->
                    </div>
                    <div id="quick-replies" class="p-4 flex flex-wrap gap-2 justify-center border-t border-slate-200">
                        <!-- Quick reply buttons will be appended here -->
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
                        <div class="flex items-center gap-4">
                            <input type="text" id="chat-input" placeholder="Type your message..." class="w-full input-base">
                            <button id="chat-send-btn" class="btn-base btn-primary !rounded-full p-3 h-12 w-12 flex items-center justify-center">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="about" class="page hidden py-20 bg-white/80 backdrop-blur-sm rounded-2xl my-16">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center text-slate-900 mb-8">About Trackify</h2>
                <p class="text-center text-slate-600 max-w-3xl mx-auto">
                    Trackify is a real-time bus tracking application designed to provide commuters with accurate, up-to-the-minute information about their bus routes. Our mission is to make public transportation more predictable, efficient, and stress-free. Using live data and an intuitive interface, we help you plan your journey better, reduce waiting times, and stay informed every step of the way. Whether you're a daily commuter or an occasional traveler, Trackify is your reliable partner for navigating the city.
                </p>
            </div>
        </section>

        <section id="contact" class="page hidden py-20">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl font-bold text-center text-slate-900 mb-8">Get In Touch</h2>
                <p class="text-center text-slate-600 max-w-3xl mx-auto mb-10">
                    Have questions, feedback, or need support? We'd love to hear from you. Reach out to us through any of the channels below.
                </p>
                <div class="max-w-sm mx-auto card p-8">
                    <ul class="space-y-4 text-slate-700">
                        <li class="flex items-center">
                            <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <a href="mailto:support@trackify.example.com" class="hover:text-blue-600">support@trackify.example.com</a>
                        </li>
                        <li class="flex items-center">
                             <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            <span>+91 123 456 7890</span>
                        </li>
                        <li class="flex items-center">
                            <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>123 Tech Park, Bhubaneswar, India</span>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full m-4 scale-95 transform opacity-0">
            <div class="flex justify-between items-start mb-4">
                 <h3 class="text-2xl font-bold text-slate-800">Confirm Your Booking</h3>
                 <button id="close-modal-btn" class="text-2xl font-light text-slate-400 hover:text-slate-600 transition-colors">&times;</button>
            </div>
           
            <div id="booking-summary" class="space-y-3 text-slate-600 mb-6 border-t border-b border-slate-200 py-4">
                <!-- Summary injected here -->
            </div>
            <h4 class="text-lg font-semibold mb-3 text-slate-700">Payment Method</h4>
            <div class="flex items-center justify-around p-4 bg-slate-100 rounded-lg mb-6">
                <img src="https://placehold.co/80x50/white/black?text=Card" alt="Credit Card" class="h-10 opacity-50 hover:opacity-100 transition-opacity cursor-pointer">
                <img src="https://placehold.co/80x50/white/black?text=UPI" alt="UPI" class="h-10 opacity-100 cursor-pointer">
                <img src="https://placehold.co/80x50/white/black?text=Wallet" alt="Wallet" class="h-10 opacity-50 hover:opacity-100 transition-opacity cursor-pointer">
            </div>
            <button id="pay-now-btn" class="w-full btn-base btn-success text-lg">Pay Now</button>
        </div>
    </div>
     <div id="toast-notification" class="fixed top-24 right-6 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-300 ease-in-out z-[110] flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>Ticket Booked Successfully!</span>
    </div>


    <footer class="bg-slate-800 text-white p-6 mt-8">
        <div class="container mx-auto max-w-7xl">
            <div class="bg-slate-900/50 p-6 rounded-2xl">
                <h3 class="font-medium text-lg mb-4 text-slate-300 text-center">Driver Simulation Panel</h3>
                <div class="max-w-2xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="auto-btn" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500">
                        <svg id="auto-btn-icon" class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="auto-btn-text" class="text-sm font-semibold">Auto Move</span>
                    </button>
                    <button id="advance-btn" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500" disabled>
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5"></path></svg>
                        <span class="text-sm font-semibold">Advance</span>
                    </button>
                    <button id="delay-btn" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500" disabled>
                        <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg>
                        <span class="text-sm font-semibold">Delay âœ¨</span>
                    </button>
                    <button id="reset-btn" class="flex flex-col items-center justify-center gap-2 py-3 px-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500" disabled>
                         <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.664 0l3.18-3.185m-3.181 3.182L12 12m0 0-3.182 3.182M12 12l3.182 3.182M12 12l-3.182-3.182M12 12a8.25 8.25 0 0 0-11.664 0L2.985 7.356m11.664 0l3.181 3.182"></path></svg>
                         <span class="text-sm font-semibold">Reset</span>
                    </button>
                </div>
            </div>
            <div class="text-center text-slate-400 text-sm mt-6">
                Â© 2024 Trackify. All rights reserved. For demonstration purposes.
            </div>
        </div>
    </footer>

    <script>
        // --- Navigation and Page Switching ---
        document.addEventListener('DOMContentLoaded', () => {
            const navToggle = document.getElementById('nav-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const openIcon = navToggle.querySelector('svg.block');
            const closeIcon = navToggle.querySelector('svg.hidden');
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const nav = document.querySelector('nav');
            let lastScrollTop = 0;

            // Retractable Navbar Logic
            window.addEventListener('scroll', () => {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > nav.offsetHeight) {
                    // Scrolling Down
                    nav.classList.add('-translate-y-full');
                } else {
                    // Scrolling Up
                    nav.classList.remove('-translate-y-full');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
            }, false);


            const toggleMobileMenu = () => {
                mobileMenu.classList.toggle('hidden');
                openIcon.classList.toggle('hidden');
                openIcon.classList.toggle('block');
                closeIcon.classList.toggle('hidden');
                closeIcon.classList.toggle('block');
            };

            navToggle.addEventListener('click', toggleMobileMenu);

            const showPage = (targetId) => {
                pages.forEach(page => {
                    if (`#${page.id}` === targetId) {
                        page.classList.remove('hidden');
                    } else {
                        page.classList.add('hidden');
                    }
                });

                navLinks.forEach(link => {
                     const linkHref = link.getAttribute('href');
                    if (linkHref === targetId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                if (!mobileMenu.classList.contains('hidden')) {
                    toggleMobileMenu();
                }

                if (targetId === '#live-tracking' && map) {
                    setTimeout(() => map.invalidateSize(), 10); 
                }
            };

            navLinks.forEach(link => {
                if (link.href.includes('#')) {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href');
                        showPage(targetId);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
            });

            const initialPage = window.location.hash || '#live-tracking';
            showPage(initialPage);
        
            initializeMap();
            initializeChatbot();
            initializeTicketBooking();
        });


        // --- Bus Data and State ---
        const originalBusData = {
            "707": { /* ... Bus data ... */ },
            "808": { /* ... Bus data ... */ },
            "909": { /* ... Bus data ... */ }
        };
        Object.assign(originalBusData["707"], { startPoint: "Amritsar", endPoint: "Patiala", currentLocationIndex: 4, stops: [ { name: "Amritsar", lat: 31.6340, lng: 74.8723, eta: "05:00 PM", ata: "05:00 PM" }, { name: "Beas", lat: 31.5167, lng: 75.2833, eta: "05:45 PM", ata: "05:46 PM" }, { name: "Kartarpur", lat: 31.4425, lng: 75.5000, eta: "06:20 PM", ata: "06:22 PM" }, { name: "Jalandhar", lat: 31.3260, lng: 75.5762, eta: "07:00 PM", ata: "07:05 PM" }, { name: "Phagwara", lat: 31.2167, lng: 75.7667, eta: "07:45 PM", ata: "07:50 PM" }, { name: "Phillaur", lat: 31.0264, lng: 75.7869, eta: "08:15 PM", ata: null }, { name: "Ludhiana", lat: 30.9010, lng: 75.8573, eta: "08:45 PM", ata: null }, { name: "Doraha", lat: 30.7963, lng: 76.0211, eta: "09:15 PM", ata: null }, { name: "Sirhind", lat: 30.6483, lng: 76.3888, eta: "09:45 PM", ata: null }, { name: "Rajpura", lat: 30.4828, lng: 76.6081, eta: "10:10 PM", ata: null }, { name: "Patiala", lat: 30.3398, lng: 76.3869, eta: "10:45 PM", ata: null } ] });
        Object.assign(originalBusData["808"], { startPoint: "Bathinda", endPoint: "Chandigarh", currentLocationIndex: 1, stops: [ { name: "Bathinda", lat: 30.2110, lng: 74.9455, eta: "07:00 PM", ata: "07:00 PM" }, { name: "Rampura Phul", lat: 30.2721, lng: 75.2421, eta: "07:40 PM", ata: "07:42 PM" }, { name: "Barnala", lat: 30.3781, lng: 75.5421, eta: "08:15 PM", ata: null }, { name: "Sangrur", lat: 30.2562, lng: 75.8361, eta: "09:00 PM", ata: null }, { name: "Dhuri", lat: 30.3698, lng: 75.8679, eta: "09:20 PM", ata: null }, { name: "Nabha", lat: 30.3746, lng: 76.1524, eta: "09:50 PM", ata: null }, { name: "Patiala", lat: 30.3398, lng: 76.3869, eta: "10:20 PM", ata: null }, { name: "Zirakpur", lat: 30.6482, lng: 76.8172, eta: "11:10 PM", ata: null }, { name: "Chandigarh", lat: 30.7333, lng: 76.7794, eta: "11:30 PM", ata: null } ] });
        Object.assign(originalBusData["909"], { startPoint: "Pathankot", endPoint: "Firozpur", currentLocationIndex: 0, stops: [ { name: "Pathankot", lat: 32.2685, lng: 75.6495, eta: "08:00 PM", ata: null }, { name: "Gurdaspur", lat: 32.0413, lng: 75.4055, eta: "08:45 PM", ata: null }, { name: "Batala", lat: 31.8186, lng: 75.2024, eta: "09:20 PM", ata: null }, { name: "Amritsar", lat: 31.6340, lng: 74.8723, eta: "10:00 PM", ata: null }, { name: "Tarn Taran", lat: 31.4532, lng: 74.9254, eta: "10:30 PM", ata: null }, { name: "Patti", lat: 31.2822, lng: 74.8588, eta: "11:00 PM", ata: null }, { name: "Zira", lat: 30.9701, lng: 74.9946, eta: "11:45 PM", ata: null }, { name: "Firozpur", lat: 30.9231, lng: 74.5971, eta: "12:15 AM", ata: null } ] });

        let busData = JSON.parse(JSON.stringify(originalBusData));
        let map;
        let busMarker, startMarker, endMarker;
        let routePolyline;
        let currentBusId = null;
        let moveInterval = null;

        // --- DOM Element Selectors ---
        const trackBtn = document.getElementById('track-btn');
        const summaryBtn = document.getElementById('summary-btn');
        const busNumberInput = document.getElementById('bus-number-input');
        const advanceBtn = document.getElementById('advance-btn');
        const delayBtn = document.getElementById('delay-btn');
        const resetBtn = document.getElementById('reset-btn');
        const autoBtn = document.getElementById('auto-btn');
        const autoBtnIcon = document.getElementById('auto-btn-icon');
        const autoBtnText = document.getElementById('auto-btn-text');

        const infoPanel = document.getElementById('info-panel');
        const welcomePanel = document.getElementById('welcome-panel');
        const notificationPanel = document.getElementById('notification-panel');
        const startPointEl = document.getElementById('start-point');
        const endPointEl = document.getElementById('end-point');
        const stopListContent = document.getElementById('stop-list-content');
        const summaryText = document.getElementById('summary-text');
        const summarySpinner = document.getElementById('summary-spinner');
        
        // --- Gemini API Call ---
        async function getGeminiResponse(userPrompt, systemPrompt = null) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }]
            };

            if (systemPrompt) {
                 payload.systemInstruction = {
                    parts: [{text: systemPrompt }]
                };
            }
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    console.error('API call failed:', response.status, response.statusText);
                    const errorBody = await response.text();
                    console.error('Error body:', errorBody);
                    return "Sorry, I'm having trouble connecting right now."; 
                }
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                     return "I'm sorry, I couldn't generate a response. Please try again.";
                }
                return text;
            } catch (error) {
                console.error('Error fetching from Gemini API:', error);
                return "Sorry, there was an error. Please try again.";
            }
        }

        // --- Map and UI Functions ---
        function initializeMap() {
            if (document.getElementById('map') && !map) {
                map = L.map('map').setView([31.1471, 75.3412], 8);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
            }
        }

        function clearMap() {
            if (map) {
                if (busMarker) map.removeLayer(busMarker);
                if (startMarker) map.removeLayer(startMarker);
                if (endMarker) map.removeLayer(endMarker);
                if (routePolyline) map.removeLayer(routePolyline);
            }
        }

        function createIcon(color) {
            return L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${color};" class="w-4 h-4 rounded-full border-2 border-white shadow-md"></div>`, iconSize: [16, 16], iconAnchor: [8, 8] });
        }
        
        const busIcon = L.divIcon({ className: 'custom-bus-icon', html: `ðŸš`, iconSize: [24, 24], iconAnchor: [12, 12] });

        function updateUIForBus(busId) {
            stopBusMovement();
            const data = busData[busId];
            if (!data) return;
            currentBusId = busId;
            welcomePanel.classList.add('hidden');
            infoPanel.classList.remove('hidden');
            infoPanel.classList.add('fade-in-element');
            startPointEl.textContent = data.startPoint;
            endPointEl.textContent = data.endPoint;
            updateStopList(busId);
            updateMap(busId);
            showNotification(data.currentLocationIndex >= data.stops.length - 1 ? `Bus #${busId} has completed its journey.` : `Now tracking Bus #${busId}.`, 'info');
            [advanceBtn, delayBtn, resetBtn, autoBtn].forEach(btn => btn.disabled = false);
        }

        function updateStopList(busId) {
            const data = busData[busId];
            stopListContent.innerHTML = '';
            data.stops.forEach((stop, index) => {
                const stopDiv = document.createElement('div');
                let bgColor = 'bg-transparent', textColor = 'text-slate-500', statusIcon = 'âšª';
                if (index < data.currentLocationIndex) {
                    bgColor = 'bg-slate-100'; textColor = 'text-slate-400 line-through'; statusIcon = 'âœ”';
                } else if (index === data.currentLocationIndex) {
                    if (index === data.stops.length - 1) { bgColor = 'bg-green-100'; textColor = 'text-green-800 font-bold'; statusIcon = 'ðŸ'; }
                    else { bgColor = 'bg-blue-100'; textColor = 'text-blue-800 font-bold'; statusIcon = 'âž¡'; }
                }
                stopDiv.className = `p-3 rounded-lg mb-2 flex items-center justify-between ${bgColor} transition-colors`;
                stopDiv.innerHTML = `<div class="flex items-center"><span class="mr-3 text-lg">${statusIcon}</span><div><p class="${textColor} font-medium">${stop.name}</p><p class="text-xs text-slate-400">ETA: ${stop.eta} ${stop.ata ? `| ATA: ${stop.ata}` : ''}</p></div></div>`;
                stopListContent.appendChild(stopDiv);
            });
        }

        function updateMap(busId) {
            const data = busData[busId];
            clearMap();
            const routeCoords = data.stops.map(s => [s.lat, s.lng]);
            const start = data.stops[0], end = data.stops[data.stops.length - 1], current = data.stops[data.currentLocationIndex];
            startMarker = L.marker([start.lat, start.lng], { icon: createIcon('#10b981') }).addTo(map).bindPopup("Start: " + start.name);
            endMarker = L.marker([end.lat, end.lng], { icon: createIcon('#ef4444') }).addTo(map).bindPopup("End: " + end.name);
            busMarker = L.marker([current.lat, current.lng], { icon: busIcon }).addTo(map).bindPopup(`Current Location: ${current.name}`);
            routePolyline = L.polyline(routeCoords, { color: '#3b82f6', weight: 5 }).addTo(map);
            map.fitBounds(routePolyline.getBounds().pad(0.1));
        }
        
        function showNotification(message, type = 'info') {
            notificationPanel.textContent = message;
            notificationPanel.className = 'mb-4 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out'; // Reset classes
            if (type === 'info') notificationPanel.classList.add('bg-blue-100', 'text-blue-800');
            else if (type === 'warning') notificationPanel.classList.add('bg-orange-100', 'text-orange-800');
            else if (type === 'error') notificationPanel.classList.add('bg-red-100', 'text-red-800');
        }
        
        // --- Time Utility Functions ---
        function parseTime(timeStr) { const [time, modifier] = timeStr.split(' '); let [hours, minutes] = time.split(':').map(Number); if (modifier === 'PM' && hours < 12) hours += 12; if (modifier === 'AM' && hours === 12) hours = 0; return { hours, minutes }; }
        function formatTime({ hours, minutes }) { const h = hours % 12 === 0 ? 12 : hours % 12; const m = minutes.toString().padStart(2, '0'); const modifier = hours >= 12 ? 'PM' : 'AM'; return `${h}:${m} ${modifier}`; }
        function addMinutes(timeStr, minsToAdd) { let { hours, minutes } = parseTime(timeStr); minutes += minsToAdd; hours += Math.floor(minutes / 60); minutes %= 60; hours %= 24; return formatTime({ hours, minutes }); }
        function calculateATABasedOnTime(eta) { const [time, modifier] = eta.split(' '); let [hours, minutes] = time.split(':').map(Number); if (modifier === 'PM' && hours < 12) hours += 12; if (modifier === 'AM' && hours === 12) hours = 0; const etaDate = new Date(); etaDate.setHours(hours, minutes, 0, 0); const simulatedArrival = new Date(etaDate.getTime() + Math.random() * 60000); return formatTime({ hours: simulatedArrival.getHours(), minutes: simulatedArrival.getMinutes() }); }

        // --- Simulation Logic ---
        function startBusMovement() {
            if (!currentBusId) return;
            const data = busData[currentBusId];
            if (data.currentLocationIndex >= data.stops.length - 1) { showNotification('Bus has reached its final destination.', 'info'); return; }
            
            autoBtnText.textContent = 'Pause';
            autoBtnIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"></path>`;
            autoBtnIcon.classList.remove('text-green-400'); autoBtnIcon.classList.add('text-yellow-400');
            delayBtn.disabled = true; advanceBtn.disabled = true;

            let currentStep = 0;
            const moveBus = () => {
                const startStop = data.stops[data.currentLocationIndex], endStop = data.stops[data.currentLocationIndex + 1];
                const newLat = startStop.lat + (endStop.lat - startStop.lat) * (currentStep / 100);
                const newLng = startStop.lng + (endStop.lng - startStop.lng) * (currentStep / 100);
                busMarker.setLatLng([newLat, newLng]).getPopup().setContent(`On the way to ${endStop.name}`);
                currentStep++;
                if (currentStep > 100) {
                    data.stops[data.currentLocationIndex + 1].ata = calculateATABasedOnTime(endStop.eta);
                    data.currentLocationIndex++;
                    updateStopList(currentBusId);
                    showNotification(`Bus arrived at ${endStop.name}.`, 'info');
                    if (data.currentLocationIndex >= data.stops.length - 1) {
                        stopBusMovement();
                        showNotification('Bus has reached its final destination.', 'info');
                        updateStopList(currentBusId);
                    } else { currentStep = 0; delayBtn.disabled = false; }
                }
            };
            moveInterval = setInterval(moveBus, 50);
        }

        function stopBusMovement() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
                autoBtnText.textContent = 'Auto Move';
                autoBtnIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>`;
                autoBtnIcon.classList.remove('text-yellow-400'); autoBtnIcon.classList.add('text-green-400');
                if(currentBusId) { delayBtn.disabled = false; advanceBtn.disabled = false; }
            }
        }

        // --- Event Listeners ---
        trackBtn.addEventListener('click', () => {
            stopBusMovement();
            const busId = busNumberInput.value.trim();
            if (busData[busId]) {
                updateUIForBus(busId);
                summaryText.classList.add('hidden');
                summaryText.textContent = '';
            } else {
                showNotification(`Bus #${busId} not found. Try 707, 808, or 909.`, 'error');
                infoPanel.classList.add('hidden');
                welcomePanel.classList.remove('hidden');
            }
        });

        advanceBtn.addEventListener('click', () => {
            stopBusMovement();
            if (!currentBusId) return;
            const data = busData[currentBusId];
            if (data.currentLocationIndex < data.stops.length - 1) {
                data.currentLocationIndex++;
                data.stops[data.currentLocationIndex].ata = calculateATABasedOnTime(data.stops[data.currentLocationIndex].eta);
                updateUIForBus(currentBusId);
                showNotification(`Bus advanced to ${data.stops[data.currentLocationIndex].name}.`, 'info');
            } else {
                showNotification('Bus has reached its final destination.', 'info');
                advanceBtn.disabled = true; delayBtn.disabled = true;
            }
        });

        delayBtn.addEventListener('click', async () => { if (!currentBusId) return; const data = busData[currentBusId]; if (data.currentLocationIndex >= data.stops.length - 1) { showNotification('Cannot delay, bus has already reached the destination.', 'warning'); return; } const delayMinutes = 10; delayBtn.disabled = true; for (let i = data.currentLocationIndex + 1; i < data.stops.length; i++) { data.stops[i].eta = addMinutes(data.stops[i].eta, delayMinutes); } updateStopList(currentBusId); const prompt = `Generate a concise, single-sentence reason for a ${delayMinutes}-minute bus delay in a city in Punjab. Mention a plausible cause like traffic, weather, or an event.`; const delayReason = await getGeminiResponse(prompt); showNotification(`Bus delayed by ${delayMinutes} minutes. ${delayReason || 'Reason unknown.'}`, 'warning'); });

        resetBtn.addEventListener('click', () => {
            stopBusMovement();
            busData = JSON.parse(JSON.stringify(originalBusData));
            clearMap();
            currentBusId = null;
            infoPanel.classList.add('hidden');
            welcomePanel.classList.remove('hidden');
            busNumberInput.value = '';
            [advanceBtn, delayBtn, resetBtn, autoBtn].forEach(btn => btn.disabled = true);
            notificationPanel.textContent = '';
            notificationPanel.className = 'mb-4 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out';
        });

        autoBtn.addEventListener('click', () => {
            if (moveInterval) stopBusMovement(); else startBusMovement();
        });
        
        summaryBtn.addEventListener('click', async () => {
            if (!currentBusId) return;
            summaryText.classList.add('hidden');
            summarySpinner.classList.remove('hidden');
            summaryBtn.disabled = true;
            const data = busData[currentBusId];
            const prompt = `Provide a brief, single-paragraph summary of the key highlights for a bus route from ${data.startPoint} to ${data.endPoint} within Punjab. Mention a few major landmarks or points of interest.`;
            const summary = await getGeminiResponse(prompt);
            summarySpinner.classList.add('hidden');
            summaryText.textContent = summary || 'Unable to generate summary at this time.';
            summaryText.classList.remove('hidden');
            summaryBtn.disabled = false;
        });

        // --- Chatbot Logic ---
        function initializeChatbot() {
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const quickRepliesContainer = document.getElementById('quick-replies');

            const quickReplies = [
                "How do I track a bus?",
                "What are the available bus routes?",
                "Tell me about Trackify"
            ];

            const appendMessage = (text, sender, isTyping = false) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message chat-message-${sender}`;
                if (isTyping) {
                    messageDiv.classList.add('typing-indicator');
                    messageDiv.id = 'typing-indicator';
                }
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const sendMessage = async (text) => {
                const userMessage = text || chatInput.value.trim();
                if (!userMessage) return;

                appendMessage(userMessage, 'user');
                chatInput.value = '';
                quickRepliesContainer.classList.add('hidden');

                appendMessage('', 'bot', true); // Typing indicator

                const systemPrompt = "You are the Trackify Assistant, a friendly and helpful chatbot for a bus tracking web app. Your goal is to guide users through the app's features. The app has the following sections: 'Live Tracking', 'Ticket Booking', 'Emergency Contacts', 'Chatbot', 'About Us', and 'Contact'. The available bus routes for tracking are 707, 808, and 909. Keep your answers concise and focused on the app. If the user asks a general knowledge question, politely answer it but try to steer the conversation back to the app's functionality.";
                
                const response = await getGeminiResponse(userMessage, systemPrompt);
                
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }

                appendMessage(response, 'bot');
            };

            quickReplies.forEach(reply => {
                const button = document.createElement('button');
                button.className = 'btn-base btn-secondary !text-sm !py-1 !px-3 !rounded-full';
                button.textContent = reply;
                button.onclick = () => sendMessage(reply);
                quickRepliesContainer.appendChild(button);
            });
            
            appendMessage("Hello! I'm the Trackify Assistant. Ask me how to use the app, or choose a suggestion below.", 'bot');

            chatSendBtn.addEventListener('click', () => sendMessage());
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // --- Ticket Booking Logic ---
        function initializeTicketBooking() {
            const fromStopSelect = document.getElementById('from-stop');
            const toStopSelect = document.getElementById('to-stop');
            const findBusesBtn = document.getElementById('find-buses-btn');
            const resultsContainer = document.getElementById('bus-results-container');
            const resultsList = document.getElementById('bus-results-list');
            const paymentModal = document.getElementById('payment-modal');
            const paymentModalContent = paymentModal.querySelector('div');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const payNowBtn = document.getElementById('pay-now-btn');
            const bookingSummary = document.getElementById('booking-summary');
            const toast = document.getElementById('toast-notification');

            // 1. Populate dropdowns
            const allStops = new Set();
            for (const busId in originalBusData) {
                originalBusData[busId].stops.forEach(stop => allStops.add(stop.name));
            }
            const sortedStops = Array.from(allStops).sort();

            fromStopSelect.innerHTML = '<option value="">Select Origin</option>';
            toStopSelect.innerHTML = '<option value="">Select Destination</option>';

            sortedStops.forEach(stopName => {
                fromStopSelect.innerHTML += `<option value="${stopName}">${stopName}</option>`;
                toStopSelect.innerHTML += `<option value="${stopName}">${stopName}</option>`;
            });

            // 2. Find Buses
            findBusesBtn.addEventListener('click', () => {
                const from = fromStopSelect.value;
                const to = toStopSelect.value;
                resultsList.innerHTML = '';

                if (!from || !to || from === to) {
                    resultsList.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-inner"><p class="text-slate-500">Please select a valid origin and destination.</p></div>`;
                    resultsContainer.classList.remove('hidden');
                    return;
                }

                const availableBuses = [];
                for (const busId in originalBusData) {
                    const bus = originalBusData[busId];
                    const fromIndex = bus.stops.findIndex(s => s.name === from);
                    const toIndex = bus.stops.findIndex(s => s.name === to);

                    if (fromIndex !== -1 && toIndex !== -1 && fromIndex < toIndex) {
                        const fare = 20 + (toIndex - fromIndex) * 10;
                        availableBuses.push({
                            busId,
                            fromStop: bus.stops[fromIndex],
                            toStop: bus.stops[toIndex],
                            fare
                        });
                    }
                }

                if (availableBuses.length === 0) {
                     resultsList.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-inner"><p class="text-slate-500">No direct buses found for this route.</p></div>`;
                } else {
                    availableBuses.forEach(bus => {
                        const resultCard = document.createElement('div');
                        resultCard.className = 'bg-white p-4 rounded-lg shadow-md flex items-center justify-between transition hover:shadow-lg hover:-translate-y-1';
                        resultCard.innerHTML = `
                            <div>
                                <p class="font-bold text-lg text-slate-800">Bus #${bus.busId}</p>
                                <p class="text-sm text-slate-500">
                                    <span>Departs: ${bus.fromStop.eta}</span> | <span>Arrives: ${bus.toStop.eta}</span>
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-xl text-green-600">â‚¹${bus.fare}</p>
                                <button class="book-now-btn mt-1 btn-base btn-primary !py-1 !px-4 !text-sm">Book Now</button>
                            </div>
                        `;
                        resultCard.querySelector('.book-now-btn').addEventListener('click', () => openPaymentModal(bus));
                        resultsList.appendChild(resultCard);
                    });
                }
                resultsContainer.classList.remove('hidden');
            });

            // 3. Payment Modal Logic
            function openPaymentModal(bookingDetails) {
                bookingSummary.innerHTML = `
                    <p><span class="font-semibold text-slate-500">Bus:</span> <span class="font-bold text-slate-800">#${bookingDetails.busId}</span></p>
                    <p><span class="font-semibold text-slate-500">From:</span> <span class="font-bold text-slate-800">${bookingDetails.fromStop.name}</span></p>
                    <p><span class="font-semibold text-slate-500">To:</span> <span class="font-bold text-slate-800">${bookingDetails.toStop.name}</span></p>
                    <p class="text-2xl font-bold text-green-600 mt-2"><span class="font-semibold text-slate-500">Fare:</span> â‚¹${bookingDetails.fare}</p>
                `;
                paymentModal.classList.remove('hidden');
                setTimeout(() => {
                    paymentModal.classList.remove('opacity-0');
                    paymentModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
            
            function closePaymentModal() {
                 paymentModal.classList.add('opacity-0');
                 paymentModalContent.classList.add('scale-95', 'opacity-0');
                 setTimeout(() => {
                    paymentModal.classList.add('hidden');
                 }, 300);
            }

            function showToast() {
                toast.classList.remove('translate-x-[150%]');
                setTimeout(() => {
                    toast.classList.add('translate-x-[150%]');
                }, 3000);
            }

            closeModalBtn.addEventListener('click', closePaymentModal);
            payNowBtn.addEventListener('click', () => {
                closePaymentModal();
                showToast();
            });

        }


    </script>
</body>
</html>


